<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generator Kupon QR Code</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
   * {
       margin: 0;
       padding: 0;
       box-sizing: border-box;
   }
   body {
       font-family: Arial, sans-serif;
       background-color: #f5f5f5;
   }
   .pages-container {
       display: flex;
       flex-direction: column;
       align-items: center;
       gap: 20px;
   }
   /* Print Area - F4 Size (330mm x 210mm, Landscape) */
   .print-area {
       width: 325mm;
       height: 195mm;
       background: white;
       margin: 10mm auto; /* Paper margin */
       padding-left: 10mm; 
       padding-top: 5mm; 
       box-shadow: 0 0 10px rgba(0,0,0,0.1);
       display: grid;
       grid-template-columns: repeat(6, 50mm); 
       grid-template-rows: repeat(6, 30mm); 
       column-gap: 1.5mm; /* gap for cutting */
       row-gap: 1.5mm; /* gap for cutting */
       break-after: avoid;
       page-break-after: always;
   }
   /* Individual coupon */
   .coupon {
       width: 50mm; 
       height: 30mm;
       border: 1px solid #000;
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 2mm;
       position: relative;
   }
   .qr-container {
       width: 25mm;
       height: 25mm; 
   }
   .qr-container img {
       width: 100%;
       height: 100%;
   }
   .coupon-number {
       width: 24mm;
       text-align: center;
       font-size: 40px; 
       font-weight: bold;
   }
  
   @media print {
       body {
           background: white;
           margin: 0;
       }
       /* Hide everything except print-area */
       body > *:not(.pages-container) {
           display: none;
       }
       .pages-container {
           width: 100vw;
           margin: 0;
           padding: 0;
       }
       .print-area {
           margin: 0;
           box-shadow: none;
           page-break-after: always;
       }
   }
   @page {
       size: 331mm 211mm; /* F4 landscape */
   }
   /* Hide button container when print */
   .button-container {
       display: block;
   }
   @media print {
     .button-container {
       display: none !important;
     }
   }
</style>
</head>
<body>
<div class="button-container" style="margin: 20px;">
  <!-- Buttons will be inserted here -->
</div>
<div class="pages-container" id="pagesContainer">
  <!-- Pages will be generated here -->
</div>
<script>
   function parseCouponCode(code) {
       const parts = code.split('-');
       if (parts.length !== 2) {
           throw new Error(`Invalid coupon code format: ${code}`);
       }
       return {
           couponCode: code || '',
           couponNumber: parts[1] || ''
       };
   }
   function generateQRUrl(text) {
       return `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(text)}&size=100x100`;
   }
   function getQueryParams() {
       const params = new URLSearchParams(window.location.search);
       const codes = params.get('codes') ? params.get('codes').split('--') : [];
       return codes.slice(0, 144); // Limit to 144 coupons
   }
   function generateCoupons() {
       const codes = getQueryParams();
       const pagesContainer = document.getElementById('pagesContainer');
       pagesContainer.innerHTML = '';
       const couponsPerPage = 36;
       const maxPages = 4;
       for (let pageNum = 0; pageNum < maxPages; pageNum++) {
           let html = '';
           for (let i = 0; i < couponsPerPage; i++) {
               const idx = pageNum * couponsPerPage + i;
               if (codes[idx]) {
                   try {
                       const parsed = parseCouponCode(codes[idx]);
                       const qrUrl = generateQRUrl(parsed.couponCode);
                       html += `
<div class="coupon">
<div class="qr-container">
<img src="${qrUrl}" alt="QR Code">
</div>
<div class="coupon-number">${parsed.couponNumber}</div>
</div>
                       `;
                   } catch (error) {
                       console.error(error.message);
                       html += `<div class="coupon"></div>`;
                   }
               } else {
                   html += `<div class="coupon"></div>`;
               }
           }
           const pageDiv = document.createElement('div');
           pageDiv.className = 'print-area';
           pageDiv.innerHTML = html;
           pagesContainer.appendChild(pageDiv);
       }
   }
   function printCoupons() {
       const pagesContainer = document.getElementById('pagesContainer');
       if (!pagesContainer.innerHTML.trim()) {
           alert('Mohon generate kupon terlebih dahulu');
           return;
       }
       window.print();
   }
   function downloadPDF() {
       const pagesContainer = document.getElementById('pagesContainer');
       if (!pagesContainer.innerHTML.trim()) {
           alert('Mohon generate kupon terlebih dahulu');
           return;
       }
       // Download all pages as one PDF
       const opt = {
           margin: 0,
           filename: 'qr-coupons.pdf',
           image: { type: 'jpeg', quality: 1.0 },
           html2canvas: {
               scale: 2,
               useCORS: true,
               backgroundColor: '#ffffff'
           },
           jsPDF: {
               unit: 'mm',
               format: [331, 215], // F4 landscape
               orientation: 'landscape'
           }
       };
       html2pdf().set(opt).from(pagesContainer).save();
   }
   window.addEventListener('load', function() {
       generateCoupons();
       // Add buttons dynamically
       const buttonContainer = document.querySelector('.button-container');
       buttonContainer.innerHTML = '';
       const printButton = document.createElement('button');
       printButton.textContent = 'Print';
       printButton.onclick = printCoupons;
       printButton.style.marginRight = '10px';
       const downloadButton = document.createElement('button');
       downloadButton.textContent = 'Download PDF';
       downloadButton.onclick = downloadPDF;
       buttonContainer.appendChild(printButton);
       buttonContainer.appendChild(downloadButton);
   });
</script>
</body>
</html>
